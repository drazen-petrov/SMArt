

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>SMArt.alchemy.top_matching_fnc &mdash; SMArt v1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SMArt
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">SMArt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutorial/index.html">Tutorial</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SMArt</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../alchemy.html">SMArt.alchemy</a> &raquo;</li>
        
      <li>SMArt.alchemy.top_matching_fnc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for SMArt.alchemy.top_matching_fnc</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">SMArt.incl</span> <span class="kn">import</span> <span class="n">np</span><span class="p">,</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">do_warn</span><span class="p">,</span> <span class="n">deque</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">SMArt.alchemy.incl</span> <span class="kn">import</span> <span class="n">Dummy</span>
<span class="kn">from</span> <span class="nn">SMArt.md.incl</span> <span class="kn">import</span> <span class="n">check_if_eq</span><span class="p">,</span> <span class="n">DescriptionPart</span><span class="p">,</span> <span class="n">Interaction</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span> <span class="n">ImproperType</span><span class="p">,</span> <span class="n">ExclusionPairType</span>
<span class="kn">from</span> <span class="nn">SMArt.md.data_st</span> <span class="kn">import</span> <span class="n">Topology</span><span class="p">,</span> <span class="n">MoleculeType</span>


<div class="viewcode-block" id="get_res_common_atoms"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_res_common_atoms">[docs]</a><span class="k">def</span> <span class="nf">get_res_common_atoms</span><span class="p">(</span><span class="o">*</span><span class="n">tops</span><span class="p">):</span>
    <span class="n">N_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
    <span class="n">flag_N_res</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tops</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span><span class="o">!=</span><span class="n">N_res</span><span class="p">:</span>
            <span class="n">flag_N_res</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">flag_N_res</span><span class="p">:</span>
        <span class="n">top_res</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_residues</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tops</span><span class="p">)</span>
        <span class="n">common_atoms</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))]</span>
        <span class="n">available_atoms_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_res</span><span class="p">):</span>
            <span class="n">temp_ND_res_states</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">)):</span>
                <span class="n">res_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_res</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">res_i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="n">top_res</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">res_i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="c1"># temp_N_at, res_name</span>
                <span class="k">if</span> <span class="n">res_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_ND_res_states</span><span class="p">:</span>
                    <span class="n">temp_ND_res_states</span><span class="p">[</span><span class="n">res_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">temp_ND_res_states</span><span class="p">[</span><span class="n">res_key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">top_i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_ND_res_states</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">temp_ND_res_state</span> <span class="ow">in</span> <span class="n">temp_ND_res_states</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">at_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">temp_ND_res_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">temp_ND_res_states</span><span class="p">[</span><span class="n">temp_ND_res_state</span><span class="p">]:</span>
                                <span class="n">common_atoms</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_res</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">res_i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">at_i</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">common_atoms</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#temp_available_atoms_group = [frozenset(top_res[top_i][res_i].atoms) for top_i in range(len(tops))]</span>
                <span class="n">temp_available_atoms_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_res</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">res_i</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))]</span>
                <span class="n">available_atoms_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_available_atoms_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_atoms_groups</span><span class="p">:</span>
            <span class="n">available_atoms_groups</span><span class="o">.</span><span class="n">append</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))])</span>
        <span class="k">return</span> <span class="n">common_atoms</span><span class="p">,</span> <span class="n">available_atoms_groups</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="generate_toptp"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_toptp">[docs]</a><span class="k">def</span> <span class="nf">generate_toptp</span><span class="p">(</span><span class="n">N_tops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">N_tops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">sol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">tops</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span>
        <span class="n">N_tops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">)</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_class&#39;</span><span class="p">,</span> <span class="n">Topology</span><span class="p">)</span>
        <span class="c1">#klass = kwargs.get(&#39;top_class&#39;, MoleculeType)</span>
    <span class="n">toptp</span> <span class="o">=</span> <span class="n">klass</span><span class="p">()</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="s1">&#39;excl_pair&#39;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">ptp_excl_pair</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># mass, p_charge, atom_type</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">ptp_int</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># for each interaction type (e.g. bonds), a counter of ptp matches</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">ptp_make_break_int</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#  for each interaction type (e.g. bonds), a counter of ptp make breaks</span>
    <span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_tops</span><span class="p">))</span> <span class="c1"># for each top one dict;</span>
        <span class="c1"># in dict for each interaction map to its sol interaction</span>
    <span class="k">if</span> <span class="n">sol</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span> <span class="o">=</span> <span class="n">toptp</span>
        <span class="c1"># atoms</span>
        <span class="n">atoms_in_sol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">sol_at_i</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">at_i</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">at_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sol_at_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sol_at_i</span> <span class="o">=</span> <span class="n">add_new_toptp_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">)</span>
                        <span class="n">ptp_atom</span> <span class="o">=</span> <span class="n">add_atom_to_row</span><span class="p">(</span><span class="n">sol_at_i</span><span class="p">,</span> <span class="p">(</span><span class="n">top_i</span><span class="p">,</span> <span class="n">at_i</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ptp_atom</span> <span class="o">=</span> <span class="n">add_atom_to_row</span><span class="p">(</span><span class="n">sol_at_i</span><span class="p">,</span> <span class="p">(</span><span class="n">top_i</span><span class="p">,</span> <span class="n">at_i</span><span class="p">))</span>
                        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span> <span class="o">+=</span> <span class="n">ptp_atom</span>
                    <span class="k">if</span> <span class="n">at_i</span> <span class="o">!=</span> <span class="n">Dummy</span><span class="p">:</span>
                        <span class="n">atoms_in_sol</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_idx</span><span class="p">)</span>
        <span class="c1"># exclusion vdw_pair pairs</span>
        <span class="c1"># 0 normal wdv; 1 excluded; 2 pair</span>
        <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1">#if row[top_i] not in (None, Dummy):</span>
                     <span class="n">update_ptp_excl_pair_row_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="p">[</span><span class="n">top_i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">row_idx</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for top_i in sol._sol.columns:</span>
<span class="sd">            for row_idx in atoms_in_sol[top_i]:</span>
<span class="sd">                generate_ptp_excl_pair_single_atom(sol, row_idx, top_i, **kwargs)</span>
<span class="sd">        atoms_in_sol = [set(at_in_sol_top_i) for at_in_sol_top_i in atoms_in_sol]</span>
<span class="sd">        for top_pair in combinations(sol._sol.columns, 2):</span>
<span class="sd">            temp_atoms_in_sol = sorted(atoms_in_sol[top_pair[0]] &amp; atoms_in_sol[top_pair[1]])</span>
<span class="sd">            for row_idx_pair in combinations(temp_atoms_in_sol, 2):</span>
<span class="sd">                sol_atom_pair = frozenset(sol.toptp.atoms[at_idx] for at_idx in row_idx_pair)</span>
<span class="sd">                if sol_atom_pair in sol.toptp.excl_pair:</span>
<span class="sd">                    sol_interaction = sol.toptp.excl_pair[sol_atom_pair]</span>
<span class="sd">                    for top_i in top_pair:</span>
<span class="sd">                        at_i_1, at_i_2 = tuple(sol._sol.loc[at_idx, top_i] for at_idx in row_idx_pair)</span>
<span class="sd">                        temp_state = get_exclusion_pair_state(at_i_1, at_i_2)</span>
<span class="sd">                        add_state2EP_ND_states(sol, sol_interaction, temp_state, top_i)</span>
<span class="sd">                #################################</span>
<span class="sd">                # only DEBUGGING ###############</span>
<span class="sd">                #################################</span>
<span class="sd">                else:</span>
<span class="sd">                    for top_i in top_pair:</span>
<span class="sd">                        at_i_1, at_i_2 = tuple(sol._sol.loc[at_idx, top_i] for at_idx in row_idx_pair)</span>
<span class="sd">                        temp_state = get_exclusion_pair_state(at_i_1, at_i_2)</span>
<span class="sd">                        assert temp_state.p == (0,)</span>
<span class="sd">                #################################</span>
<span class="sd">                # only DEBUGGING ###############</span>
<span class="sd">                #################################</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># interactions</span>
        <span class="k">for</span> <span class="n">top_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)):</span>
            <span class="n">done_interactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">top2add_i</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">top_pos</span><span class="p">]</span> <span class="c1"># this is actually the same</span>
            <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">top_atom_list_01</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">top2add_i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">top2add_i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">top2add_i</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">top_pos</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                            <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">top_i</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]))</span>
                    <span class="n">update_ptp_interactions</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_list_01</span><span class="p">,</span> <span class="n">done_interactions</span> <span class="o">=</span> <span class="n">done_interactions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">toptp</span></div>

<div class="viewcode-block" id="get_generator_ptp_excl_pair_single_atom"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_generator_ptp_excl_pair_single_atom">[docs]</a><span class="k">def</span> <span class="nf">get_generator_ptp_excl_pair_single_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">done_sol_atom_pairs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># exclusion vdw_pair pairs</span>
    <span class="c1"># 0 normal wdv; 1 excluded; 2 pair</span>
    <span class="k">if</span> <span class="n">done_sol_atom_pairs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">done_sol_atom_pairs</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span>
    <span class="n">at_i</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">top_i</span><span class="p">]</span>
    <span class="c1"># from EP_l</span>
    <span class="k">for</span> <span class="n">other_at_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">at_i</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">top_i</span><span class="p">,</span> <span class="n">other_at_i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">:</span>
            <span class="n">other_row_idx</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">[(</span><span class="n">top_i</span><span class="p">,</span> <span class="n">other_at_i</span><span class="p">)]</span>
            <span class="n">sol_atom_pair</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">row_idx</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">other_row_idx</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">sol_atom_pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done_sol_atom_pairs</span><span class="p">:</span>
                <span class="n">ep_state</span> <span class="o">=</span> <span class="n">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">at_i</span><span class="p">,</span> <span class="n">other_at_i</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">])</span>
                <span class="k">yield</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">ep_state</span></div>

<div class="viewcode-block" id="generate_ptp_excl_pair_single_atom"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_ptp_excl_pair_single_atom">[docs]</a><span class="k">def</span> <span class="nf">generate_ptp_excl_pair_single_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">done_sol_atom_pairs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">temp_state</span> <span class="ow">in</span> <span class="n">get_generator_ptp_excl_pair_single_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">add_new_excl_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_i</span><span class="p">)</span></div>

<div class="viewcode-block" id="add_new_excl_pair"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_new_excl_pair">[docs]</a><span class="k">def</span> <span class="nf">add_new_excl_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_i</span><span class="p">):</span>
    <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ExclusionPairType</span><span class="p">)</span>
    <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">temp_state</span><span class="p">:</span> <span class="p">{</span><span class="n">top_i</span><span class="p">}}</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">sol_interaction</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sol_at1</span><span class="p">,</span> <span class="n">sol_at2</span> <span class="o">=</span> <span class="n">sol_atom_pair</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add_atom_pair2EP_l</span><span class="p">(</span><span class="n">sol_at1</span><span class="p">,</span> <span class="n">sol_at2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sol_interaction</span></div>

<div class="viewcode-block" id="update_ptp"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.update_ptp">[docs]</a><span class="k">def</span> <span class="nf">update_ptp</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">,</span> <span class="n">old_sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># get list of atoms that are being matched:</span>
    <span class="c1"># (1,1) for atom atom; (n,1) for row atom; (n,m) for row row</span>
    <span class="n">top_atom_list_01</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Dummy</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row_idx0</span> <span class="o">=</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">top_idx_at_pair_0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old_sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_idx0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">top_idx_at_pair_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_idx_at_pair_0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># both rows</span>
                <span class="n">row_idx1</span> <span class="o">=</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">top_idx_at_pair_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old_sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_idx1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">top_idx_at_pair_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                        <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_idx_at_pair_1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span><span class="c1"># row atom</span>
                <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span><span class="c1">#atom atom new row</span>
            <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">########################</span>
    <span class="c1"># atom ptp and excl pair</span>
    <span class="c1">########################</span>
    <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">temp_at</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span><span class="c1"># both rows</span>
            <span class="n">row_idx2</span> <span class="o">=</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">temp_at2</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">row_idx2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
                <span class="n">add_atom_m_to_row</span><span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p_ch</span> <span class="ow">in</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">:</span>
                <span class="n">add_atom_pch_to_row</span><span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">p_ch</span><span class="p">,</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">[</span><span class="n">p_ch</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a_type</span> <span class="ow">in</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">:</span>
                <span class="n">add_atom_a_type_to_row</span><span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">a_type</span><span class="p">,</span> <span class="n">temp_at2</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">a_type</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span><span class="p">)</span>
            <span class="c1">########################################################</span>
            <span class="c1"># pair excl</span>
            <span class="c1">########################################################</span>
            <span class="n">update_ptp_excl_pair_row_row_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">temp_at2</span><span class="p">),</span> <span class="n">top_atom_list_01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1">#del(sol.toptp.atoms[row_idx2])</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># atom 2 row</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span> <span class="o">+=</span> <span class="n">add_atom_to_row</span><span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">update_ptp_excl_pair_row_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">temp_at</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># atom atom pair - new row</span>
        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">[</span><span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">temp_at</span> <span class="o">=</span> <span class="n">add_new_toptp_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">ptp_atom</span> <span class="o">=</span> <span class="n">add_atom_to_row</span><span class="p">(</span><span class="n">temp_at</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_atom</span> <span class="o">+=</span> <span class="n">ptp_atom</span>
        <span class="n">update_ptp_excl_pair_atom_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1">################################</span>
    <span class="c1"># interactions #################</span>
    <span class="c1">################################</span>
    <span class="k">if</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Dummy</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">update_ptp_interactions</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_list_01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def get_exclusion_pair_state(at1, at2):</span>
<span class="sd">    if at2 in at1.e_l:</span>
<span class="sd">        assert at1 in at2.e_l</span>
<span class="sd">        return ExclusionType(params = [1])</span>
<span class="sd">    elif at2 in at1.p_l:</span>
<span class="sd">        assert at1 in at2.p_l</span>
<span class="sd">        return ExclusionType(params = [2])</span>
<span class="sd">    else:</span>
<span class="sd">        assert at1 not in at2.e_l and at1 not in at2.p_l</span>
<span class="sd">        return ExclusionType(params = [0])</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="get_exclusion_pair_state_from_EP"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_exclusion_pair_state_from_EP">[docs]</a><span class="k">def</span> <span class="nf">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">at1</span><span class="p">,</span> <span class="n">at2</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">at2</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">at1</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">at1</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">at2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">top</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">at1</span><span class="p">,</span> <span class="n">at2</span><span class="p">))]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">top_state</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">at1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">at2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ExclusionPairType</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span></div>

<div class="viewcode-block" id="add_state2EP_ND_states"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_state2EP_ND_states">[docs]</a><span class="k">def</span> <span class="nf">add_state2EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_idx</span><span class="p">):</span>
    <span class="n">match_ND_state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ND_state</span> <span class="ow">in</span> <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ND_state</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="n">temp_state</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="n">match_ND_state</span> <span class="o">=</span> <span class="n">ND_state</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">match_ND_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_excl_pair</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">temp_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">top_idx</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">match_ND_state</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">top_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="merge_EP_ND_states"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.merge_EP_ND_states">[docs]</a><span class="k">def</span> <span class="nf">merge_EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction</span><span class="p">,</span> <span class="n">sol_interaction2</span><span class="p">):</span>
    <span class="n">done_ND_states2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ND_state</span> <span class="ow">in</span> <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
        <span class="n">flag_not_matched</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">temp_state</span> <span class="ow">in</span> <span class="n">sol_interaction2</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ND_state</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="n">temp_state</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
                <span class="n">flag_not_matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">done_ND_states2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_state</span><span class="p">)</span>
                <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">ND_state</span><span class="p">]</span> <span class="o">|=</span> <span class="n">sol_interaction2</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">temp_state</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag_not_matched</span><span class="p">:</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_excl_pair</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ND_state</span> <span class="ow">in</span> <span class="n">sol_interaction2</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ND_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done_ND_states2</span><span class="p">:</span>
            <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">ND_state</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_interaction2</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">ND_state</span><span class="p">]</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_excl_pair</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="update_ptp_excl_pair_atom_atom_pair"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.update_ptp_excl_pair_atom_atom_pair">[docs]</a><span class="k">def</span> <span class="nf">update_ptp_excl_pair_atom_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1">#if top_atom_pair[i][1] not in (None, Dummy):</span>
            <span class="n">update_ptp_excl_pair_row_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_pair</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">row_idx</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_ptp_excl_pair_row_atom_pair"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.update_ptp_excl_pair_row_atom_pair">[docs]</a><span class="k">def</span> <span class="nf">update_ptp_excl_pair_row_atom_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom</span><span class="p">,</span> <span class="n">sol_atom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">top_atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">done_sol_atom_pair</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">other_sol_at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">sol_atom</span><span class="p">]:</span>
    <span class="c1">#for other_sol_at in sol_atom.EP_l:</span>
        <span class="n">sol_atom_pair</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol_atom</span><span class="p">,</span> <span class="n">other_sol_at</span><span class="p">))</span>
        <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="n">sol_atom_pair</span><span class="p">]</span>
        <span class="n">other_atom</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">other_atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
            <span class="n">temp_state</span> <span class="o">=</span> <span class="n">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">top_atom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_atom</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">add_state2EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">done_sol_atom_pair</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_atom_pair</span><span class="p">)</span>
    <span class="n">temp_gen</span> <span class="o">=</span> <span class="n">get_generator_ptp_excl_pair_single_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_atom</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">done_sol_atom_pair</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">sol_state</span> <span class="ow">in</span> <span class="n">temp_gen</span><span class="p">:</span>
        <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">add_new_excl_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_atom_pair</span><span class="p">,</span> <span class="n">sol_state</span><span class="p">,</span> <span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top_i</span><span class="o">!=</span><span class="n">top_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># skip the top from which the added atom comes from</span>
                <span class="n">row_idx_pair</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol_atom_pair</span><span class="p">]</span>
                <span class="n">atom_pair_i</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_idx_pair</span><span class="p">,</span> <span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_pair_i</span> <span class="ow">and</span> <span class="n">Dummy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_pair_i</span><span class="p">:</span>
                    <span class="n">temp_state</span> <span class="o">=</span> <span class="n">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">atom_pair_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_pair_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">])</span>
                    <span class="n">add_state2EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_i</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_ptp_excl_pair_row_row_pair"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.update_ptp_excl_pair_row_row_pair">[docs]</a><span class="k">def</span> <span class="nf">update_ptp_excl_pair_row_row_pair</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_atoms_pair</span><span class="p">,</span> <span class="n">top_atom_list_01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">########################</span>
    <span class="c1"># at this point, in sol, we just poped out sol_atoms_pair[1] from toptp.atoms</span>
    <span class="c1"># so we need to be sure that searching with the id is not used...</span>
    <span class="c1">########################</span>
    <span class="n">done_sol_atom_pair</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">sol_atom_0</span><span class="p">,</span> <span class="n">sol_atom_1</span> <span class="o">=</span> <span class="n">sol_atoms_pair</span>
    <span class="k">for</span> <span class="n">other_sol_at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">sol_atom_0</span><span class="p">]:</span>
    <span class="c1">#for other_sol_at in sol_atom_0.EP_l:</span>
        <span class="n">sol_atom_pair_0</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol_atom_0</span><span class="p">,</span> <span class="n">other_sol_at</span><span class="p">))</span>
        <span class="n">sol_interaction_0</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="n">sol_atom_pair_0</span><span class="p">]</span>
        <span class="n">sol_atom_pair_1</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol_atom_1</span><span class="p">,</span> <span class="n">other_sol_at</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sol_atom_pair_1</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">:</span>
            <span class="n">sol_interaction_1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sol_atom_pair_1</span><span class="p">)</span>
            <span class="n">merge_EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction_0</span><span class="p">,</span> <span class="n">sol_interaction_1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">top_atom_1</span> <span class="ow">in</span> <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">other_atom_1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">top_atom_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">other_atom_1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">temp_state</span> <span class="o">=</span> <span class="n">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">top_atom_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_atom_1</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_atom_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">add_state2EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction_0</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_atom_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="n">temp_state</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
        <span class="n">done_sol_atom_pair</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_atom_pair_1</span><span class="p">)</span>
    <span class="n">EP_l_sol_atom_1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">EP_l</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sol_atom_1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">other_sol_at</span> <span class="ow">in</span> <span class="n">EP_l_sol_atom_1</span><span class="p">:</span>
        <span class="n">sol_atom_pair_1</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol_atom_1</span><span class="p">,</span> <span class="n">other_sol_at</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sol_atom_pair_1</span> <span class="ow">in</span> <span class="n">done_sol_atom_pair</span><span class="p">:</span><span class="k">continue</span>
        <span class="n">sol_interaction_1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="n">sol_atom_pair_1</span><span class="p">]</span>
        <span class="n">sol_atom_pair_0</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">sol_atom_0</span><span class="p">,</span> <span class="n">other_sol_at</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">sol_atom_pair_0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="n">sol_atom_pair_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_interaction_1</span>
        <span class="k">for</span> <span class="n">top_atom_0</span> <span class="ow">in</span> <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">other_atom_0</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">other_sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">top_atom_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">other_atom_0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                <span class="n">temp_state</span> <span class="o">=</span> <span class="n">get_exclusion_pair_state_from_EP</span><span class="p">(</span><span class="n">top_atom_0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_atom_0</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_atom_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">add_state2EP_ND_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_interaction_1</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">top_atom_0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">temp_state</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">sol_at</span> <span class="o">!=</span> <span class="n">sol_atom_1</span>
<span class="c1">#        if sol_at != sol_atom_1:</span>
        <span class="k">if</span> <span class="n">sol_atom_1</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">sol_at</span><span class="p">]:</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">EP_l</span><span class="p">[</span><span class="n">sol_at</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sol_atom_1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">sol_at</span><span class="o">!=</span><span class="n">sol_atom_0</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add_atom_pair2EP_l</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">sol_atom_0</span><span class="p">)</span></div>

<div class="viewcode-block" id="add_atom_to_row"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_atom_to_row">[docs]</a><span class="k">def</span> <span class="nf">add_atom_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">top_atom_id</span><span class="p">):</span>
    <span class="n">st_at</span><span class="p">,</span> <span class="n">at</span> <span class="o">=</span> <span class="n">top_atom_id</span> <span class="c1"># st_at is the same top_idx</span>
    <span class="n">st_at</span> <span class="o">=</span> <span class="p">{</span><span class="n">st_at</span><span class="p">}</span>
    <span class="n">ptp_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">add_atom_m_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">)</span>
    <span class="n">add_atom_pch_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">p_ch</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">)</span>
    <span class="n">add_atom_a_type_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">a_type</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptp_atom</span></div>

<div class="viewcode-block" id="update_ptp_interactions"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.update_ptp_interactions">[docs]</a><span class="k">def</span> <span class="nf">update_ptp_interactions</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_atom_list_01</span><span class="p">,</span> <span class="n">done_interactions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">done_interactions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">done_interactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">top_at0</span> <span class="ow">in</span> <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">top_at1</span> <span class="ow">in</span> <span class="n">top_atom_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">top_pair_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_at0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_at1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">top0</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">top1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">top_01</span> <span class="o">=</span> <span class="p">(</span><span class="n">top0</span><span class="p">,</span> <span class="n">top1</span><span class="p">)</span>
            <span class="n">at0</span> <span class="o">=</span> <span class="n">top_at0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">at1</span> <span class="o">=</span> <span class="n">top_at1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">int_matches</span><span class="p">,</span> <span class="n">int_ptp</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">find_interactions_ptp</span><span class="p">(</span><span class="n">at0</span><span class="p">,</span> <span class="n">at1</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span>
                                                                              <span class="n">done_interactions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1">#############################</span>
                <span class="c1"># same (matched) interactions</span>
                <span class="c1">#############################</span>
                <span class="k">for</span> <span class="n">int_match</span> <span class="ow">in</span> <span class="n">int_matches</span><span class="p">:</span>
                    <span class="n">other_int_states</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">other_int_state</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                        <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">sol_ND_state_tops_set</span> <span class="o">=</span> <span class="n">find_ND_state_tops_set</span><span class="p">(</span><span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">,</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">other_sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">other_int_states</span> <span class="o">=</span> <span class="n">other_sol_interaction</span><span class="o">.</span><span class="n">int_states</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">other_int_state</span> <span class="o">=</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">sol_ND_state_tops_set</span> <span class="o">=</span> <span class="n">find_ND_state_tops_set</span><span class="p">(</span><span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">,</span>
                                                                           <span class="n">int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">other_int_state</span> <span class="o">=</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_interaction</span> <span class="o">=</span> <span class="n">top0</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span><span class="p">)</span>
                            <span class="n">new_interaction</span><span class="o">.</span><span class="n">ND_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="nb">set</span><span class="p">(</span><span class="n">top_pair_ind</span><span class="p">)}</span>
                            <span class="n">new_interaction</span><span class="o">.</span><span class="n">int_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                <span class="n">new_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">int_match</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_interaction</span>
                            <span class="c1">#sol.toptp.add2container(new_interaction, create=True, db_type=list)</span>
                            <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_interaction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">other_int_states</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">top_i_other</span><span class="p">,</span> <span class="n">int_match_other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other_int_states</span><span class="p">):</span>
                            <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_match_other</span>
                            <span class="n">sol_ND_state_tops_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">top_i_other</span><span class="p">)</span>
                            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_i_other</span><span class="p">][</span><span class="n">int_match_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_interaction</span>
                        <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_interaction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">other_int_state</span><span class="p">:</span>
                        <span class="n">top_i_other</span><span class="p">,</span> <span class="n">int_match_other</span> <span class="o">=</span> <span class="n">other_int_state</span>
                        <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_match_other</span>
                        <span class="n">sol_ND_state_tops_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">top_i_other</span><span class="p">)</span>
                        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_i_other</span><span class="p">][</span><span class="n">int_match_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_interaction</span>
                        <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_interaction</span><span class="p">)</span>
                <span class="c1">######################################</span>
                <span class="c1"># different (not matched) interactions</span>
                <span class="c1">######################################</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">int_ptp</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">sol_interaction</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">sol_interaction_2</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]:</span>
                            <span class="k">if</span> <span class="n">sol_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]]</span>
                                <span class="n">top_i_other</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sol_interaction_2</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">sol_interaction_2</span> <span class="ow">and</span> <span class="n">sol_interaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sol_interaction_2</span><span class="p">:</span>
                        <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sol_interaction_2</span><span class="o">.</span><span class="n">ND_states</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">top_set</span> <span class="ow">in</span> <span class="n">sol_interaction_2</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">top_set</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="n">int_i</span> <span class="o">=</span> <span class="n">sol_interaction_2</span>
                                <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_i</span>
                                <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">int_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_interaction</span>
                        <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_interaction_2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sol_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sol_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">sol_interaction</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span><span class="p">)</span>
                                    <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]}}</span>
                                    <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
                                    <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
                                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_interaction</span>
                                    <span class="n">top_i_other</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                        <span class="k">if</span> <span class="n">int_ptp</span><span class="p">[</span><span class="n">top_i_other</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">top_i_other</span>
                            <span class="n">sol_interaction</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
                            <span class="n">sol_interaction</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
                            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_interaction</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">container_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_make_break_int</span><span class="p">:</span>
                                <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_make_break_int</span><span class="p">[</span><span class="n">container_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_make_break_int</span><span class="p">[</span><span class="n">container_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_interaction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">container_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_int</span><span class="p">:</span>
                        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_int</span><span class="p">[</span><span class="n">container_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_int</span><span class="p">[</span><span class="n">container_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="find_ND_state_tops_set"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.find_ND_state_tops_set">[docs]</a><span class="k">def</span> <span class="nf">find_ND_state_tops_set</span><span class="p">(</span><span class="n">ND_states</span><span class="p">,</span> <span class="n">state_top_i</span><span class="p">,</span> <span class="n">top_i</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state_top_i</span> <span class="ow">in</span> <span class="n">ND_states</span> <span class="ow">and</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">ND_states</span><span class="p">[</span><span class="n">state_top_i</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">ND_states</span><span class="p">[</span><span class="n">state_top_i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">tops_set</span> <span class="ow">in</span> <span class="n">ND_states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">tops_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tops_set</span></div>

<div class="viewcode-block" id="add_new_toptp_atom"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_new_toptp_atom">[docs]</a><span class="k">def</span> <span class="nf">add_new_toptp_atom</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">):</span>
    <span class="n">sol_at</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">row_idx</span><span class="p">)</span>
    <span class="c1">#sol_at.sol_id = sol_at.id</span>
    <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_pch_states</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#sol_at.EP_l = set()</span>
    <span class="k">return</span> <span class="n">sol_at</span></div>

<div class="viewcode-block" id="add_atom_m_to_row"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_atom_m_to_row">[docs]</a><span class="k">def</span> <span class="nf">add_atom_m_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at_m</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">at_m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">at_m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
            <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">at_m</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="c1">#ptp_atom[0] += 1</span>
        <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">at_m</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st_at</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_if_eq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">at_m</span><span class="p">):</span>
                <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st_at</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">at_m</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_at</span>
            <span class="n">ptp_atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="add_atom_pch_to_row"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_atom_pch_to_row">[docs]</a><span class="k">def</span> <span class="nf">add_atom_pch_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at_p_ch</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">at_p_ch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">at_p_ch</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if at_p_ch not in sol_at.ND_pch_states:</span>
<span class="sd">            sol_at.ND_pch_states[at_p_ch] = set()</span>
<span class="sd">            ptp_atom[1] += 1</span>
<span class="sd">        sol_at.ND_pch_states[at_p_ch] |= st_at</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">at_p_ch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if at_p_ch not in sol_at.ND_pch_states:</span>
<span class="sd">            sol_at.ND_pch_states[at_p_ch] = set()</span>
<span class="sd">            ptp_atom[1] += 1</span>
<span class="sd">        sol_at.ND_pch_states[at_p_ch] |= st_at</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">pch</span> <span class="ow">in</span> <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_if_eq</span><span class="p">(</span><span class="n">pch</span><span class="p">,</span> <span class="n">at_p_ch</span><span class="p">):</span>
                <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">[</span><span class="n">pch</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st_at</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">[</span><span class="n">at_p_ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_at</span>
            <span class="n">ptp_atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="add_atom_a_type_to_row"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_atom_a_type_to_row">[docs]</a><span class="k">def</span> <span class="nf">add_atom_a_type_to_row</span><span class="p">(</span><span class="n">sol_at</span><span class="p">,</span> <span class="n">at_a_type</span><span class="p">,</span> <span class="n">st_at</span><span class="p">,</span> <span class="n">ptp_atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">at_a_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">at_a_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">:</span>
            <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">at_a_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">ptp_atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">at_a_type</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st_at</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">a_type</span> <span class="ow">in</span> <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_type</span> <span class="ow">and</span> <span class="n">a_type</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">at_a_type</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">a_type</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st_at</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">sol_at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">at_a_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_at</span>
            <span class="n">ptp_atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flag</span></div>

<span class="c1"># interactions</span>
<span class="k">def</span> <span class="nf">_sep_int_groups_ptp_flags</span><span class="p">(</span><span class="n">int_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">sep_int_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="n">int_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()]]</span>
    <span class="k">while</span> <span class="n">int_list</span><span class="p">:</span>
        <span class="n">temp_int</span> <span class="o">=</span> <span class="n">int_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">temp_int_list</span> <span class="ow">in</span> <span class="n">sep_int_lists</span><span class="p">:</span>
            <span class="n">temp_int2</span> <span class="o">=</span> <span class="n">temp_int_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">temp_int</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">check_eq_ptp_flag_params</span><span class="p">(</span><span class="n">temp_int2</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
                <span class="n">temp_int_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_int</span><span class="p">)</span>
                <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag_no_match</span><span class="p">:</span>
            <span class="n">sep_int_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">temp_int</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sep_int_lists</span>

<span class="k">def</span> <span class="nf">_check_imp_tetrahedral_order</span><span class="p">(</span><span class="n">at0_list_mapped_to_1</span><span class="p">,</span> <span class="n">at1_list</span><span class="p">):</span>  <span class="c1"># for tetrahedral</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">at0_list_mapped_to_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">at1_list</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">at0_list_mapped_to_1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">at1_list</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_convert_improper_params_atom_order</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="n">improper_0</span><span class="p">,</span> <span class="n">improper_1</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">orig_params</span> <span class="o">=</span>  <span class="n">improper_1</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">flag_same_order</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at_0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">improper_0</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">atoms_01_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">at_0</span><span class="p">]:</span>
            <span class="n">flag_same_order</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">flag_same_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">orig_params</span>
    <span class="n">bond_c_0</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">improper_type</span><span class="p">(</span><span class="n">improper_0</span><span class="p">)</span>
    <span class="n">bond_c_1</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">improper_type</span><span class="p">(</span><span class="n">improper_1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bond_c_0</span> <span class="o">!=</span> <span class="n">bond_c_1</span><span class="p">:</span>
        <span class="n">do_warn</span><span class="p">(</span><span class="s1">&#39;different improper types with different atom order!!!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bond_c_0</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">c_pos_0</span> <span class="o">=</span> <span class="n">bond_c_0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">c_pos_1</span> <span class="o">=</span> <span class="n">bond_c_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">improper_0</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_flat_pair</span> <span class="ow">and</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_flat_pair</span><span class="p">:</span>
            <span class="n">imp_flat_c_pos_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">imp_flat_c_pos_map</span><span class="p">[</span><span class="n">c_pos_0</span><span class="p">]</span> <span class="o">==</span> <span class="n">imp_flat_c_pos_map</span><span class="p">[</span><span class="n">c_pos_1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">orig_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_tetra_pair</span><span class="p">[</span><span class="n">orig_params</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">c_pos_0</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c_pos_1</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">improper_0</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_tetra_pair</span> <span class="ow">and</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_tetra_pair</span><span class="p">:</span>
                <span class="c1">################################### this needs one more check!!!!!!!!!!!!!!!!!</span>
                <span class="c1">################################### calc energies / angles and compare!!!!!!!!!!!!</span>
                <span class="k">if</span> <span class="n">c_pos_0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">at0_rest_list</span> <span class="o">=</span> <span class="n">improper_0</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">at0_rest_list</span> <span class="o">=</span> <span class="n">improper_0</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">c_pos_1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">at1_rest_list</span> <span class="o">=</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">at1_rest_list</span> <span class="o">=</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">at0_rest_mapped_to_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">atoms_01_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">at_0</span><span class="p">]</span> <span class="k">for</span> <span class="n">at_0</span> <span class="ow">in</span> <span class="n">at0_rest_list</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_check_imp_tetrahedral_order</span><span class="p">(</span><span class="n">at0_rest_mapped_to_1</span><span class="p">,</span> <span class="n">at1_rest_list</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">orig_params</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">imp_tetra_pair</span><span class="p">[</span><span class="n">orig_params</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_warn</span><span class="p">(</span><span class="s1">&#39;one of the imporpers is not in flat pair and has the central atom in the middle!!!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag_rev_same_order</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at_0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">improper_0</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">improper_1</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">atoms_01_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">at_0</span><span class="p">]:</span>
                <span class="n">flag_rev_same_order</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag_rev_same_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">orig_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_warn</span><span class="p">(</span><span class="s1">&#39;1-2-3-4 improper types with different atom order!!!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_find_interactions_ptp_atom_set</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="n">ptp_score_kwargs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ptp_score_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ptp_score_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">int_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">int_ptp</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_ptp_flags&#39;</span><span class="p">):</span>
        <span class="c1"># separated into sub-groups of the interactions that are allowed to be matches (e.g. dihedrals with same mult)</span>
        <span class="n">sep_int_lists0</span> <span class="o">=</span> <span class="n">_sep_int_groups_ptp_flags</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">int_list0</span><span class="p">))</span>
        <span class="n">sep_int_lists1</span> <span class="o">=</span> <span class="n">_sep_int_groups_ptp_flags</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">int_list1</span><span class="p">))</span>
        <span class="n">sep_int_lists_01</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">sep_int_lists0</span><span class="p">:</span>
            <span class="n">temp_sep_int_list0</span> <span class="o">=</span> <span class="n">sep_int_lists0</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">temp_sep_int_list1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sep_int_lists1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">temp_sep_int_list0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">check_eq_ptp_flag_params</span><span class="p">(</span><span class="n">temp_sep_int_list1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">sep_int_lists_01</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">temp_sep_int_list0</span><span class="p">,</span> <span class="n">temp_sep_int_list1</span><span class="p">))</span>
                    <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sep_int_lists1</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">flag_no_match</span><span class="p">:</span>
                <span class="n">sep_int_lists_01</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">temp_sep_int_list0</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">while</span> <span class="n">sep_int_lists1</span><span class="p">:</span>
            <span class="n">sep_int_lists_01</span><span class="o">.</span><span class="n">append</span><span class="p">(([],</span> <span class="n">sep_int_lists1</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="n">ptp_score_kwargs</span><span class="p">[</span><span class="s1">&#39;flag_ptp_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">sep_int_list_01</span> <span class="ow">in</span> <span class="n">sep_int_lists_01</span><span class="p">:</span>
            <span class="n">temp_int_matches</span><span class="p">,</span> <span class="n">temp_int_ptp</span> <span class="o">=</span> <span class="n">_find_interactions_ptp_atom_set</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="n">sep_int_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">sep_int_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="n">ptp_score_kwargs</span><span class="o">=</span><span class="n">ptp_score_kwargs</span><span class="p">)</span>
            <span class="n">int_matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp_int_matches</span><span class="p">)</span>
            <span class="n">int_ptp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp_int_ptp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">int_ptp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">temp_int_ptp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">int_matches</span><span class="p">,</span> <span class="n">int_ptp</span>
<span class="c1"># find eq pairs of int</span>
    <span class="n">int_list_ptp0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flag_improper</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">int_list0</span> <span class="ow">and</span> <span class="n">int_list0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">!=</span> <span class="n">ImproperType</span><span class="p">:</span>
        <span class="n">flag_improper</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">int_list1</span> <span class="ow">and</span> <span class="n">int_list1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">!=</span> <span class="n">ImproperType</span><span class="p">:</span>
        <span class="n">flag_improper</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="n">int_list0</span><span class="p">:</span>
        <span class="n">int0</span> <span class="o">=</span> <span class="n">int_list0</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">int1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">int_list1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flag_improper</span><span class="p">:</span>
                <span class="n">params2check</span> <span class="o">=</span> <span class="n">_convert_improper_params_atom_order</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="n">int0</span><span class="p">,</span> <span class="n">int1</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params2check</span> <span class="o">=</span> <span class="n">int1</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">params2check</span> <span class="ow">and</span> <span class="n">int0</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">check_eq_params</span><span class="p">(</span><span class="n">params2check</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
                <span class="n">int_matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">int0</span><span class="p">,</span> <span class="n">int1</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">int_list1</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                <span class="n">flag_no_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag_no_match</span><span class="p">:</span>
            <span class="n">int_list_ptp0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">int0</span><span class="p">)</span>
<span class="c1"># find best ptp combination of matches</span>
    <span class="n">int_list0</span> <span class="o">=</span> <span class="n">int_list_ptp0</span>
    <span class="n">int_ptp</span> <span class="o">=</span> <span class="n">find_best_ptp_matches</span><span class="p">(</span><span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">,</span> <span class="n">flag_improper</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="n">ptp_score_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">int_matches</span><span class="p">,</span> <span class="n">int_ptp</span>


<div class="viewcode-block" id="find_best_ptp_matches"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.find_best_ptp_matches">[docs]</a><span class="k">def</span> <span class="nf">find_best_ptp_matches</span><span class="p">(</span><span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">,</span> <span class="n">flag_improper</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="n">ptp_score_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">int_ptp</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_best_ptp_matches&#39;</span><span class="p">):</span>
        <span class="n">len_int_list_01</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list1</span><span class="p">)</span>
        <span class="n">N_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">len_int_list_01</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_max</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">len_int_list_01</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">int_ptp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">int_ptp</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list1</span><span class="p">):</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">int_list_01</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">)[::</span><span class="n">fac</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">int_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">perm_int_list_longer</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">int_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">temp_int_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">perm_int_list_longer</span><span class="p">,</span> <span class="n">int_list_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">temp_int_match</span> <span class="ow">in</span> <span class="n">temp_int_matches</span><span class="p">:</span>
                <span class="n">int0</span><span class="p">,</span> <span class="n">int1</span> <span class="o">=</span> <span class="n">temp_int_match</span><span class="p">[::</span><span class="n">fac</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">flag_improper</span><span class="p">:</span>
                    <span class="n">state2check</span> <span class="o">=</span> <span class="n">_convert_improper_params_atom_order</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="n">int0</span><span class="p">,</span> <span class="n">int1</span><span class="p">,</span> <span class="n">atoms_01_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">temp_score</span> <span class="o">=</span> <span class="n">int0</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calc_ptp_score</span><span class="p">(</span><span class="n">state2check</span><span class="p">,</span> <span class="o">**</span><span class="n">ptp_score_kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_score</span> <span class="o">=</span> <span class="n">int0</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">calc_ptp_score</span><span class="p">(</span><span class="n">int1</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">ptp_score_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">temp_score</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param_sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temp_score</span><span class="p">):</span>
                        <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param_sc</span>
            <span class="k">if</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_score</span> <span class="o">&gt;</span> <span class="n">score</span><span class="p">:</span>
                    <span class="n">best_perm_match</span> <span class="o">=</span> <span class="n">temp_int_matches</span>
                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_perm_match</span> <span class="o">=</span> <span class="n">temp_int_matches</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="k">for</span> <span class="n">temp_int_match</span> <span class="ow">in</span> <span class="n">best_perm_match</span><span class="p">:</span>
            <span class="n">temp_int_match</span> <span class="o">=</span> <span class="n">temp_int_match</span><span class="p">[::</span><span class="n">fac</span><span class="p">]</span>
            <span class="n">int_ptp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">int_ptp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">int_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">temp_int</span> <span class="ow">in</span> <span class="n">int_list_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">temp_int_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_int</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[::</span><span class="n">fac</span><span class="p">]</span>
        <span class="n">int_ptp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_int_match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">int_ptp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_int_match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">int_ptp</span></div>

<span class="k">def</span> <span class="nf">_check_extra_dih_in_sol</span><span class="p">(</span><span class="n">temp_int_i</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">top_i_idx</span><span class="p">,</span> <span class="n">top_ii_idx</span><span class="p">,</span> <span class="n">sol</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">temp_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dih_at</span> <span class="o">=</span> <span class="n">temp_int_i</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dih_at_other</span> <span class="o">=</span> <span class="n">temp_int_i</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">][(</span><span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">at_neigh_i</span> <span class="ow">in</span> <span class="n">top_i</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">dih_at</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">at_neigh_i</span><span class="o">!=</span><span class="n">dih_at_other</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">top_i_idx</span><span class="p">,</span> <span class="n">at_neigh_i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">:</span>
                    <span class="n">at_neigh_ii</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_common_atom_pair</span><span class="p">((</span><span class="n">top_i_idx</span><span class="p">,</span> <span class="n">at_neigh_i</span><span class="p">),</span> <span class="n">top_ii_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">at_neigh_ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Dummy</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">temp_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1">#if temp_count &gt; 1:break</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">temp_count</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_find_int_list_01_to_compare</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">int_container_01</span><span class="p">,</span> <span class="n">done_interactions</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">flag_int_allow_not_found</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_int_allow_not_found&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">int_container_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">int_container_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">flag_dih</span><span class="p">,</span> <span class="n">atom_range</span><span class="p">,</span> <span class="n">dihedral_match_v</span> <span class="o">=</span> <span class="n">flag_dih_params</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">temp_int_i</span> <span class="ow">in</span> <span class="n">int_container_01</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">temp_int_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]:</span>
                    <span class="n">temp_sol_interaction</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">temp_int_i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">temp_sol_interaction</span> <span class="ow">in</span> <span class="n">done_interactions</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="sd">&quot;&quot;&quot;                </span>
<span class="sd">                if temp_int_i in done_int_01[i]:</span>
<span class="sd">                    continue</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">atoms_i</span> <span class="o">=</span> <span class="n">temp_int_i</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">atom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">atoms_ii</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">int_at_i</span> <span class="ow">in</span> <span class="n">atoms_i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">int_at_i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">:</span>
                        <span class="n">int_at_ii</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_common_atom_pair</span><span class="p">((</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">int_at_i</span><span class="p">),</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">int_at_ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Dummy</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">atoms_ii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">int_at_ii</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms_ii</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">flag_dih</span><span class="p">:</span><span class="c1"># flag_dih is only true when it&#39;s dihedral and dihedral_match_version == 1</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_extra_dih_in_sol</span><span class="p">(</span><span class="n">temp_int_i</span><span class="p">,</span> <span class="n">top_01</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">sol</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="n">int_list_i</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find_interactions</span><span class="p">(</span><span class="n">atoms_i</span><span class="p">,</span> <span class="n">int_container_01</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">dihedral_match_v</span><span class="p">,</span>
                                                <span class="n">allow_not_found</span><span class="o">=</span><span class="n">flag_int_allow_not_found</span><span class="p">,</span> <span class="n">allow_multiple_matches</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">int_list_ii</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">find_interactions</span><span class="p">(</span><span class="n">atoms_ii</span><span class="p">,</span> <span class="n">int_container_01</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="n">dihedral_match_v</span><span class="p">,</span>
                                                <span class="n">allow_not_found</span><span class="o">=</span><span class="n">flag_int_allow_not_found</span><span class="p">,</span> <span class="n">allow_multiple_matches</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">int_list_i</span><span class="p">,</span> <span class="n">int_list_ii</span><span class="p">)[::</span><span class="n">fac</span><span class="p">],</span> <span class="p">(</span><span class="n">atoms_i</span><span class="p">,</span> <span class="n">atoms_ii</span><span class="p">)[::</span><span class="n">fac</span><span class="p">]</span>

<div class="viewcode-block" id="gen_int_container_01_list_new"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.gen_int_container_01_list_new">[docs]</a><span class="k">def</span> <span class="nf">gen_int_container_01_list_new</span><span class="p">(</span><span class="n">at0</span><span class="p">,</span> <span class="n">at1</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;generator for interaction containers to be checked for matches&quot;&quot;&quot;</span>
<span class="c1"># all but dihedrals</span>
    <span class="n">done_containers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flag_dih_params</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="mi">2</span>
    <span class="c1">#for int_container0, container_name in at0.get_interaction_containers(get_container_name=True):</span>
    <span class="k">for</span> <span class="n">int_container0</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atom_interactions</span><span class="p">[</span><span class="n">at0</span><span class="p">]</span><span class="o">.</span><span class="n">get_interaction_containers</span><span class="p">(</span><span class="n">get_container_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#if int_container0 and int_container0[0].int_type==top_01[0].DihedralType:continue</span>
            <span class="k">if</span> <span class="n">int_container0</span> <span class="ow">and</span> <span class="n">int_container0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">DihedralType</span><span class="p">:</span><span class="k">continue</span>
        <span class="n">int_container1</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atom_interactions</span><span class="p">[</span><span class="n">at1</span><span class="p">]</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">,</span> <span class="n">allow_not_found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">int_container1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_container1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">done_containers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container_name</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">int_container0</span><span class="p">,</span> <span class="n">int_container1</span><span class="p">),</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span>
    <span class="c1">#for int_container1, container_name in at1.get_interaction_containers(get_container_name=True):</span>
    <span class="k">for</span> <span class="n">int_container1</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atom_interactions</span><span class="p">[</span><span class="n">at1</span><span class="p">]</span><span class="o">.</span><span class="n">get_interaction_containers</span><span class="p">(</span><span class="n">get_container_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">done_containers</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#if int_container1 and int_container1[0].int_type==top_01[1].DihedralType:continue</span>
            <span class="k">if</span> <span class="n">int_container1</span> <span class="ow">and</span> <span class="n">int_container1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">DihedralType</span><span class="p">:</span><span class="k">continue</span>
        <span class="n">int_container0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">int_container0</span><span class="p">,</span> <span class="n">int_container1</span><span class="p">),</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span>
<span class="c1"># dihedrals extra if dihedral_match_version == 1 (matching 2 middle atoms)</span>
    <span class="n">container_name</span> <span class="o">=</span> <span class="s1">&#39;dihedrals&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flag_dih_params</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">int_container_01</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">neigh_at0</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">at0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neigh_at0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">:</span>
                <span class="n">neigh_at1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_common_atom_pair</span><span class="p">((</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neigh_at0</span><span class="p">),</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">neigh_at1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">neigh_at_01</span> <span class="o">=</span> <span class="n">neigh_at0</span><span class="p">,</span> <span class="n">neigh_at1</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="c1">#temp_dih_container_01 = neigh_at_01[i].get_container(top_01[i].DihedralType ,flag_class = True, allow_not_found = True)</span>
                        <span class="c1">#temp_dih_container_01 = neigh_at_01[i].get_container(container_name, allow_not_found = True)</span>
                        <span class="n">temp_dih_container_01</span> <span class="o">=</span> <span class="n">top_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">atom_interactions</span><span class="p">[</span><span class="n">neigh_at_01</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">get_container</span>\
                            <span class="p">(</span><span class="n">container_name</span><span class="p">,</span> <span class="n">allow_not_found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">temp_dih_container_01</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">temp_dih</span> <span class="ow">in</span> <span class="n">temp_dih_container_01</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">neigh_at_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">temp_dih</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                                    <span class="n">int_container_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dih</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">int_container_01</span><span class="p">,</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span></div>

<div class="viewcode-block" id="gen_int_container_01_list"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.gen_int_container_01_list">[docs]</a><span class="k">def</span> <span class="nf">gen_int_container_01_list</span><span class="p">(</span><span class="n">at0</span><span class="p">,</span> <span class="n">at1</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;generator for interaction containers to be checked for matches&quot;&quot;&quot;</span>
<span class="c1"># all but dihedrals</span>
    <span class="n">done_containers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flag_dih_params</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">int_container0</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">at0</span><span class="o">.</span><span class="n">get_interaction_containers</span><span class="p">(</span><span class="n">get_container_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#for int_container0, container_name in top_01[0].atom_interactions[at0].get_interaction_containers(get_container_name=True):</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#if int_container0 and int_container0[0].int_type==top_01[0].DihedralType:continue</span>
            <span class="k">if</span> <span class="n">int_container0</span> <span class="ow">and</span> <span class="n">int_container0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">DihedralType</span><span class="p">:</span><span class="k">continue</span>
        <span class="n">int_container1</span> <span class="o">=</span> <span class="n">at1</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">,</span> <span class="n">allow_not_found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">int_container1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_container1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">done_containers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container_name</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">int_container0</span><span class="p">,</span> <span class="n">int_container1</span><span class="p">),</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span>
    <span class="k">for</span> <span class="n">int_container1</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">at1</span><span class="o">.</span><span class="n">get_interaction_containers</span><span class="p">(</span><span class="n">get_container_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#for int_container1, container_name in top_01[1].atom_interactions[at1].get_interaction_containers(get_container_name=True):</span>
        <span class="k">if</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">done_containers</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#if int_container1 and int_container1[0].int_type==top_01[1].DihedralType:continue</span>
            <span class="k">if</span> <span class="n">int_container1</span> <span class="ow">and</span> <span class="n">int_container1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">DihedralType</span><span class="p">:</span><span class="k">continue</span>
        <span class="n">int_container0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">int_container0</span><span class="p">,</span> <span class="n">int_container1</span><span class="p">),</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span>
<span class="c1"># dihedrals extra if dihedral_match_version == 1 (matching 2 middle atoms)</span>
    <span class="n">container_name</span> <span class="o">=</span> <span class="s1">&#39;dihedrals&#39;</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flag_dih_params</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">int_container_01</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>
        <span class="n">done_int_01</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">neigh_at0</span> <span class="ow">in</span> <span class="n">top_01</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">at0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neigh_at0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol_atoms_map</span><span class="p">:</span>
                <span class="n">neigh_at1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_common_atom_pair</span><span class="p">((</span><span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">neigh_at0</span><span class="p">),</span> <span class="n">top_pair_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">neigh_at1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">neigh_at_01</span> <span class="o">=</span> <span class="n">neigh_at0</span><span class="p">,</span> <span class="n">neigh_at1</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="c1">#temp_dih_container_01 = neigh_at_01[i].get_container(top_01[i].DihedralType ,flag_class = True, allow_not_found = True)</span>
                        <span class="n">temp_dih_container_01</span> <span class="o">=</span> <span class="n">neigh_at_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">,</span> <span class="n">allow_not_found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">temp_dih_container_01</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">temp_dih</span> <span class="ow">in</span> <span class="n">temp_dih_container_01</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">neigh_at_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">temp_dih</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                                    <span class="n">int_container_01</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dih</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">int_container_01</span><span class="p">,</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span></div>

<div class="viewcode-block" id="find_interactions_ptp"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.find_interactions_ptp">[docs]</a><span class="k">def</span> <span class="nf">find_interactions_ptp</span><span class="p">(</span><span class="n">at0</span><span class="p">,</span> <span class="n">at1</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">done_interactions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">temp_gen_out</span> <span class="o">=</span> <span class="n">gen_int_container_01_list_new</span><span class="p">(</span><span class="n">at0</span><span class="p">,</span> <span class="n">at1</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">int_container_01</span><span class="p">,</span> <span class="n">done_int_01</span><span class="p">,</span> <span class="n">flag_dih_params</span><span class="p">,</span> <span class="n">container_name</span> <span class="ow">in</span> <span class="n">temp_gen_out</span><span class="p">:</span>
        <span class="c1">#temp_gen_inner = _find_int_list_01_to_compare(sol, top_01, top_pair_ind, int_container_01, done_int_01,</span>
        <span class="n">temp_gen_inner</span> <span class="o">=</span> <span class="n">_find_int_list_01_to_compare</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_01</span><span class="p">,</span> <span class="n">top_pair_ind</span><span class="p">,</span> <span class="n">int_container_01</span><span class="p">,</span> <span class="n">done_interactions</span><span class="p">,</span>
                                                      <span class="n">flag_dih_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># generates lists of interactions from top0 and from top1 based on set of common atoms</span>
        <span class="c1"># in principle, the groups are of len == 1, but for e.g. dihedrals this could be &gt; 1</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">int_list0</span><span class="p">,</span> <span class="n">int_list1</span><span class="p">),</span> <span class="n">atoms_01</span> <span class="ow">in</span> <span class="n">temp_gen_inner</span><span class="p">:</span>
            <span class="n">atoms_01_map</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">atoms_01</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms_01</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># maps atoms0 &lt;-&gt; atoms1</span>
            <span class="c1"># this map is needed for impropers, as one can specify the same improper using different order of atoms</span>
            <span class="n">int_matches</span><span class="p">,</span> <span class="n">int_ptp</span> <span class="o">=</span> <span class="n">_find_interactions_ptp_atom_set</span><span class="p">(</span><span class="n">top_01</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">int_list0</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">int_list1</span><span class="p">),</span>
                                                                   <span class="n">atoms_01_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">int_matches</span><span class="p">,</span> <span class="n">int_ptp</span><span class="p">,</span> <span class="n">container_name</span></div>

<span class="k">def</span> <span class="nf">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">sol_interaction</span><span class="p">):</span>
    <span class="n">sol_interaction</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">find_sol_atom</span><span class="p">((</span><span class="n">top_i</span><span class="p">,</span> <span class="n">at</span><span class="p">))</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">int_i</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_sol_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">flag_dih_v_1</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">tops2check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sol_int</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ND_state</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">ND_state</span><span class="p">]:</span>
                <span class="n">sol_int</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ND_state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tops2check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flag_dih_v_1</span><span class="p">:</span>
        <span class="n">flag_atoms_in_sol</span> <span class="o">=</span> <span class="n">_check_sol_dih_v_1_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">tops2check</span><span class="o">=</span><span class="n">tops2check</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag_atoms_in_sol</span> <span class="o">=</span> <span class="n">_check_sol_int_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">tops2check</span><span class="o">=</span><span class="n">tops2check</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ND_state</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="p">[</span><span class="n">ND_state</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">flag_atoms_in_sol</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1">#sol_int.states[top_i] = Dummy</span>

<span class="k">def</span> <span class="nf">_check_sol_atoms_if_real</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">list_tops2check</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">top_set</span> <span class="ow">in</span> <span class="n">list_tops2check</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">temp_top_i</span> <span class="ow">in</span> <span class="n">top_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sol_row</span><span class="p">[</span><span class="n">temp_top_i</span><span class="p">]</span> <span class="o">==</span> <span class="n">Dummy</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_check_sol_int_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">tops2check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_range</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    checks if atoms of each topology (corresonding to the sol_int.atoms) are physical (non-Dummy) atoms</span>
<span class="sd">    :param sol:</span>
<span class="sd">    :param sol_int:</span>
<span class="sd">    :return: list of bools</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flag_atoms_in_sol</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tops2check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tops2check</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">tops2check</span><span class="p">:</span>
        <span class="n">temp_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">atom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
            <span class="n">sol_row</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sol_row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">==</span> <span class="n">Dummy</span><span class="p">:</span>
                <span class="n">temp_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="n">flag_atoms_in_sol</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_flag</span>
    <span class="k">return</span> <span class="n">flag_atoms_in_sol</span>

<span class="k">def</span> <span class="nf">_check_sol_dih_v_1_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">tops2check</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    same as _check_sol_int_atoms (but for dihedrals under dihedral_match_v==1 condition)</span>
<span class="sd">    :param sol:</span>
<span class="sd">    :param sol_int:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># first_check the middle 2 atoms</span>
    <span class="k">if</span> <span class="n">tops2check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tops2check</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">flag_atoms_in_sol</span> <span class="o">=</span> <span class="n">_check_sol_int_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">tops2check</span><span class="o">=</span><span class="n">tops2check</span><span class="p">,</span> <span class="n">atom_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="c1"># now check the neighbours of the middle 2, could be any...</span>
    <span class="n">sol_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">tops2check</span><span class="p">:</span>
        <span class="n">top_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol_row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="k">for</span> <span class="n">sol_row</span> <span class="ow">in</span> <span class="n">sol_rows</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">top_at</span> <span class="ow">in</span> <span class="n">top_atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag_atoms_in_sol</span><span class="p">[</span><span class="n">top_i</span><span class="p">]:</span>
                <span class="n">temp_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">at_neigh</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">top_at</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">at_neigh</span> <span class="o">!=</span> <span class="n">Dummy</span> <span class="ow">and</span> <span class="n">at_neigh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_atoms</span><span class="p">:</span>
                        <span class="n">temp_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="n">flag_atoms_in_sol</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">temp_flag</span>
    <span class="k">return</span> <span class="n">flag_atoms_in_sol</span>


<span class="k">def</span> <span class="nf">_check_sol_dih_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">atom_i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">sol_row</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">top_set</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">temp_top_i</span> <span class="ow">in</span> <span class="n">top_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sol_row</span><span class="p">[</span><span class="n">temp_top_i</span><span class="p">]</span> <span class="o">==</span> <span class="n">Dummy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_get_masses_real_atoms</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">list_tops2check</span><span class="p">):</span>
    <span class="n">masses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">top_set</span> <span class="ow">in</span> <span class="n">list_tops2check</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">temp_top_i</span> <span class="ow">in</span> <span class="n">top_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sol_row</span><span class="p">[</span><span class="n">temp_top_i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Dummy</span><span class="p">:</span>
                <span class="n">masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_row</span><span class="p">[</span><span class="n">temp_top_i</span><span class="p">]</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">masses</span>

<span class="c1">############################################</span>
<span class="c1"># generating making multi state topologies #</span>
<span class="c1">############################################</span>

<div class="viewcode-block" id="generate_multi_state_top"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_multi_state_top">[docs]</a><span class="k">def</span> <span class="nf">generate_multi_state_top</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generates multi state topology (and ptp topology) based on the solution</span>
<span class="sd">    :param sol: solution (from MCS)</span>
<span class="sd">    :param top_state: state to use to generate the topology (0 default)</span>
<span class="sd">    :kwargs</span>
<span class="sd">        add_DUM_exclusions: adds exclusions betweeen dummies from different states (True by default)</span>
<span class="sd">        flag_EP2excl: generates exclusions and pairse from EP</span>
<span class="sd">        flag_bond_constraints: generates constraints to all bonds except the perturbed ones</span>

<span class="sd">        also to be passed on to the following functions:</span>
<span class="sd">            generate_atom_states, generate_int_states, find_atom_order</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ff</span>
    <span class="c1">#sol.toptp.top_state = top_state</span>
    <span class="n">generate_atom_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1">#generate_atom_top_state(sol, **kwargs)</span>
    <span class="n">generate_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_DUM_exclusions&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">add_DUM_exclusions</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">set_top_state</span><span class="p">(</span><span class="n">top_state</span> <span class="o">=</span> <span class="n">top_state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_EP2excl&#39;</span><span class="p">):</span>
        <span class="n">generate_excl_from_EP</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
    <span class="n">ordered_atoms</span> <span class="o">=</span> <span class="n">find_atom_order</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ordered_atoms</span><span class="p">:</span>
        <span class="n">c</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">at</span><span class="o">.</span><span class="n">sol_id</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">id</span>
        <span class="n">at</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1">#at.gr_id = str(at.id)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">ordered_atoms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ordered_atoms</span><span class="p">:</span>
            <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ordered_atoms</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">cg</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">cg</span><span class="p">):</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1"># add constraints if there is bond ptp</span>
    <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_int</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bonds&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_bond_constraints&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">excl_bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ND_states</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">excl_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">generate_constraints</span><span class="p">(</span><span class="n">excl_bonds</span> <span class="o">=</span> <span class="n">excl_bonds</span><span class="p">)</span>
    <span class="n">get_residues_v1</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
    <span class="n">get_res_atom_names_v1</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
    <span class="n">get_sys_title</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span></div>

<div class="viewcode-block" id="generate_atom_states"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_atom_states">[docs]</a><span class="k">def</span> <span class="nf">generate_atom_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">ff_dumm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ff_dumm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ff_dumm</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_DUM_type</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span>
        <span class="c1"># mass</span>
        <span class="n">at</span><span class="o">.</span><span class="n">m_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m_state</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">m_state</span><span class="p">]:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_state</span>
        <span class="c1"># partial charge</span>
        <span class="n">at</span><span class="o">.</span><span class="n">p_ch_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p_ch_state</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_pch_states</span><span class="p">[</span><span class="n">p_ch_state</span><span class="p">]:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">p_ch_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_ch_state</span>
        <span class="c1"># atom type</span>
        <span class="n">at</span><span class="o">.</span><span class="n">a_type_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a_type_state</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_type_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">a_type_state</span><span class="p">]:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">a_type_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff_dumm</span>
                    <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">p_ch_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>
                    <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_a_type_states</span><span class="p">[</span><span class="n">a_type_state</span><span class="p">]:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">a_type_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_type_state</span></div>

<div class="viewcode-block" id="add_DUM_exclusions"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.add_DUM_exclusions">[docs]</a><span class="k">def</span> <span class="nf">add_DUM_exclusions</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">ff_dumm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ff_dumm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ff_dumm</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_DUM_type</span>
    <span class="n">atoms_non_DUM_states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span> 
        <span class="n">st_non_dum</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at_state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">a_type_states</span><span class="p">)</span> <span class="k">if</span> <span class="n">at_state</span> <span class="o">!=</span> <span class="n">ff_dumm</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_non_dum</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">st_non_dum</span> <span class="o">=</span> <span class="n">st_non_dum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">atoms_non_DUM_states</span><span class="p">[</span><span class="n">st_non_dum</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">top_i_pair</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">at_0</span> <span class="ow">in</span> <span class="n">atoms_non_DUM_states</span><span class="p">[</span><span class="n">top_i_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="k">for</span> <span class="n">at_1</span> <span class="ow">in</span> <span class="n">atoms_non_DUM_states</span><span class="p">[</span><span class="n">top_i_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                    <span class="n">temp_interaction</span> <span class="o">=</span> <span class="n">Interaction</span><span class="p">(</span><span class="n">ExclusionPairType</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">(</span><span class="n">at_0</span><span class="p">,</span> <span class="n">at_1</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)):</span>
                        <span class="n">temp_interaction</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">fnc_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,))</span>
                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">temp_interaction</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">at_0</span><span class="p">,</span> <span class="n">at_1</span><span class="p">)),</span> <span class="n">replace</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add_atom_pair2EP_l</span><span class="p">(</span><span class="n">at_0</span><span class="p">,</span> <span class="n">at_1</span><span class="p">)</span></div>

<div class="viewcode-block" id="generate_atom_top_state"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_atom_top_state">[docs]</a><span class="k">def</span> <span class="nf">generate_atom_top_state</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">other_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag_EDS_mass&#39;</span><span class="p">):</span>
            <span class="n">temp_masses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">temp_w</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">temp_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">temp_w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>
            <span class="n">at</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">temp_masses</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">temp_w</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">other_state</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">other_state</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;atom mass not defined for neither of the states:</span><span class="se">\n</span><span class="si">{:s}</span><span class="s1">  </span><span class="si">{:d}</span><span class="s1">  </span><span class="si">{:d}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">,</span> <span class="n">other_state</span><span class="p">))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">other_state</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;atom mass not defined for top_state and has more than 1 ND_states: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">ND_m_states</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">m_states</span><span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">p_ch</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">p_ch_states</span><span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">a_type</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">a_type_states</span><span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">]</span></div>

<div class="viewcode-block" id="generate_excl_from_EP"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_excl_from_EP">[docs]</a><span class="k">def</span> <span class="nf">generate_excl_from_EP</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">atom_pair</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">:</span>
        <span class="n">temp_EP</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="p">[</span><span class="n">atom_pair</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_EP</span><span class="o">.</span><span class="n">ND_states</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ptp_excl_pair</span><span class="o">!=</span><span class="mi">0</span>
            <span class="n">temp_EP</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ExclusionPairType</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span></div>

<div class="viewcode-block" id="generate_int_states"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.generate_int_states">[docs]</a><span class="k">def</span> <span class="nf">generate_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">#generate_atom_states(sol, **kwargs)</span>
    <span class="n">dihedral_match_v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dihedral_match_v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">done_interactions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">dihedrals2fix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ep_int</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">excl_pair</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_get_sol_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">ep_int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">int_cont</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">get_interaction_containers</span><span class="p">(</span><span class="n">EP_cont_exclude</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">int_cont</span><span class="p">:</span>
                <span class="n">flag_dih_v_1</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">int_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_i</span><span class="p">]:</span>
                    <span class="n">sol_int</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">interaction_states_map</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">int_i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sol_int</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">int_i</span><span class="o">.</span><span class="n">int_type</span><span class="p">)</span>
                    <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">int_i</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span><span class="n">top_i</span><span class="p">}}</span>
                    <span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span>
                    <span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_i</span>
                    <span class="n">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span>
                    <span class="n">_get_sol_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span> <span class="c1"># in this case this is also fine for the dihedrals of v==1 (as they have to be DUM in the other states)</span>
                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">sol_int</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">continue</span>
                    <span class="c1">#done_interactions.add(sol_int) # not needed as not matched to any other interaction (all other states DUM)</span>
                <span class="k">if</span> <span class="n">sol_int</span> <span class="ow">in</span> <span class="n">done_interactions</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">flag_OK</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">ImproperType</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">temp_top_i</span><span class="p">,</span> <span class="n">temp_int_state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">temp_int_state</span> <span class="ow">and</span> <span class="n">temp_int_state</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="p">:</span>
                            <span class="n">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">temp_top_i</span><span class="p">,</span> <span class="n">temp_int_state</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="c1">#elif sol_int.int_states[top_i].int_type == top.DihedralType:</span>
                <span class="k">elif</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">int_states</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">int_type</span> <span class="o">==</span> <span class="n">DihedralType</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dihedral_match_v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">flag_dih_v_1</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_sol_dih_atoms</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">):</span>
                            <span class="n">flag_OK</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">dihedrals2fix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_int</span><span class="p">)</span>
                            <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_int</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_get_sol_int_atoms_simple</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">int_i</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag_OK</span><span class="p">:</span>
                    <span class="n">_get_sol_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">flag_dih_v_1</span> <span class="o">=</span> <span class="n">flag_dih_v_1</span><span class="p">)</span>
                    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">sol_int</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">done_interactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sol_int</span><span class="p">)</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">gen_graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sol_int</span> <span class="ow">in</span> <span class="n">dihedrals2fix</span><span class="p">:</span>
        <span class="n">N_tops2check</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">top_set</span> <span class="ow">in</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">N_tops2check</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_set</span><span class="p">)</span>
        <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">flag_OK</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">mid_atom_1_i</span><span class="p">,</span> <span class="n">mid_atom_2_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span>
            <span class="n">sol_row</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_check_sol_atoms_if_real</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">flag_OK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_masses</span> <span class="o">=</span> <span class="n">_get_masses_real_atoms</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">best_masses</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">mid_atom_1</span><span class="p">,</span> <span class="n">mid_atom_2</span> <span class="o">=</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">mid_atom_1_i</span><span class="p">],</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">mid_atom_2_i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">neigh_atom</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">mid_atom_1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">neigh_atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mid_atom_2</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
                        <span class="n">sol_row</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neigh_atom</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                        <span class="n">temp_masses</span> <span class="o">=</span> <span class="n">_get_masses_real_atoms</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="n">temp_masses</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="n">flag_better</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_masses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_masses</span><span class="p">):</span>
                            <span class="n">flag_better</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_masses</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_tops2check</span><span class="p">:</span>
                                <span class="n">flag_OK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">assert</span> <span class="n">_check_sol_atoms_if_real</span><span class="p">(</span><span class="n">sol_row</span><span class="p">,</span> <span class="n">sol_int</span><span class="o">.</span><span class="n">ND_states</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_masses</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_masses</span><span class="p">)</span> <span class="ow">and</span> <span class="n">temp_masses</span> <span class="o">&gt;</span> <span class="n">best_masses</span><span class="p">:</span>
                            <span class="n">flag_better</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">flag_better</span><span class="p">:</span>
                            <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">neigh_atom</span>
                            <span class="n">best_masses</span> <span class="o">=</span> <span class="n">temp_masses</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_OK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">flag_OK</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">do_warn</span><span class="p">(</span><span class="s1">&#39;dihedral is not represented in all states by real atoms:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sol_int</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">_get_sol_int_states</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">sol_int</span><span class="p">,</span> <span class="n">flag_dih_v_1</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">sol_int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_add_next_atom_2_stack</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">tops_order</span><span class="p">,</span> <span class="n">atoms2order</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">tops_order</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span>
            <span class="n">sol_at</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_sol_atom</span><span class="p">((</span><span class="n">top_i</span><span class="p">,</span> <span class="n">at</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">atoms2order</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
                <span class="k">return</span>

<div class="viewcode-block" id="find_atom_order"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.find_atom_order">[docs]</a><span class="k">def</span> <span class="nf">find_atom_order</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">tops_order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tops_order&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tops_order</span><span class="p">:</span>
        <span class="n">tops_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">]</span>
        <span class="n">tops_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">top_i</span> <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">top_i</span> <span class="o">!=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">top_state</span><span class="p">])</span>
        <span class="c1"># starts with sol.toptp.top_state and other ordered</span>
    <span class="n">atoms2order</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">())</span>
    <span class="n">ordered_atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">atoms2order</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">sol_at</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">atoms2order</span><span class="p">:</span>
                <span class="n">sol_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">sol_at</span><span class="p">]</span>
                <span class="n">sol_atoms_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">sol_at</span><span class="p">}</span>
                <span class="n">cg_atoms_set</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">tops_order</span><span class="p">:</span>
                    <span class="n">at_i</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">top_i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">at_i</span> <span class="o">!=</span> <span class="n">Dummy</span><span class="p">:</span>
                        <span class="n">temp_cg_atoms_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">cg_at</span> <span class="ow">in</span> <span class="n">at_i</span><span class="o">.</span><span class="n">cg</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                            <span class="n">temp_sol_at</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">find_sol_atom</span><span class="p">((</span><span class="n">top_i</span><span class="p">,</span> <span class="n">cg_at</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">temp_sol_at</span> <span class="ow">in</span> <span class="n">atoms2order</span><span class="p">:</span>
                                <span class="n">temp_cg_atoms_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_sol_at</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">temp_sol_at</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sol_atoms_set</span><span class="p">:</span>
                                    <span class="n">sol_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_sol_at</span><span class="p">)</span>
                                    <span class="n">sol_atoms_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_sol_at</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cg_atoms_set</span><span class="p">:</span>
                            <span class="n">cg_atoms_set</span> <span class="o">&amp;=</span> <span class="n">temp_cg_atoms_set</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cg_atoms_set</span> <span class="o">=</span> <span class="n">temp_cg_atoms_set</span>
                <span class="n">temp_stack_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">cg</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">ChargeGroup</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol_atoms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">cg_atoms_set</span><span class="p">:</span>
                        <span class="n">cg</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
                        <span class="n">ordered_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
                        <span class="n">atoms2order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">sol_at</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_stack_set</span><span class="p">:</span>
                        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
        <span class="n">_add_next_atom_2_stack</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">tops_order</span><span class="p">,</span> <span class="n">atoms2order</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ordered_atoms</span></div>

<div class="viewcode-block" id="get_residues_v1"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_residues_v1">[docs]</a><span class="k">def</span> <span class="nf">get_residues_v1</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">current_residues_atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">current_res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">():</span>
        <span class="n">flag_curr_res</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">top_i_curr_res</span> <span class="ow">in</span> <span class="n">current_residues_atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">temp_res_atoms</span> <span class="ow">in</span> <span class="n">top_i_curr_res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">temp_res_atoms</span><span class="p">:</span>
                    <span class="n">flag_curr_res</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_curr_res</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag_curr_res</span><span class="p">:</span>
            <span class="n">current_res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">current_residues_atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">top_i</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_res</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="n">flag_type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">current_res</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">sol_at</span><span class="p">)</span>
        <span class="c1">#current_res.gr_id = current_res.id</span>
        <span class="k">for</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">top_i_curr_res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_residues_atoms</span><span class="p">):</span>
            <span class="n">top_at</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">sol_id</span><span class="p">,</span> <span class="n">top_i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">top_at</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">top_at</span><span class="o">.</span><span class="n">res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_residues_atoms</span><span class="p">[</span><span class="n">top_i</span><span class="p">]:</span>
                    <span class="n">current_residues_atoms</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">top_at</span><span class="o">.</span><span class="n">res</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">top_at</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                <span class="n">current_residues_atoms</span><span class="p">[</span><span class="n">top_i</span><span class="p">][</span><span class="n">top_at</span><span class="o">.</span><span class="n">res</span><span class="p">]</span> <span class="o">-=</span> <span class="p">{</span><span class="n">top_at</span><span class="p">}</span></div>

<div class="viewcode-block" id="get_state_names"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_state_names">[docs]</a><span class="k">def</span> <span class="nf">get_state_names</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_residues</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">names</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;st_</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span></div>

<div class="viewcode-block" id="get_res_atom_names_v1"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_res_atom_names_v1">[docs]</a><span class="k">def</span> <span class="nf">get_res_atom_names_v1</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ptp_eds_res_name</span> <span class="o">=</span> <span class="s1">&#39;PTPR&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ptp_eds_res_name</span> <span class="o">=</span> <span class="s1">&#39;EDSR&#39;</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">get_residues</span><span class="p">():</span>
        <span class="n">res_atom_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">temp_residues_all</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sol_at</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">atom_names</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">top_i</span><span class="p">,</span> <span class="n">top_at</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">_sol</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sol_at</span><span class="o">.</span><span class="n">sol_id</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">top_at</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">):</span>
                    <span class="n">temp_residues_all</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">top_at</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
                    <span class="n">atom_names</span><span class="p">[</span><span class="n">top_at</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">temp_at_name</span> <span class="o">=</span> <span class="n">atom_names</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">temp_at_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_atom_names</span><span class="p">:</span>
                <span class="n">res_atom_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_at_name</span><span class="p">)</span>
                <span class="n">sol_at</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">temp_at_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp_at_name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_find_next_code</span><span class="p">(</span><span class="n">res_atom_names</span><span class="p">,</span> <span class="n">pref</span> <span class="o">=</span> <span class="s1">&#39;PT&#39;</span><span class="p">)</span>
                <span class="n">res_atom_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_at_name</span><span class="p">)</span>
                <span class="n">sol_at</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">temp_at_name</span>
        <span class="n">res_names</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">temp_res</span> <span class="ow">in</span> <span class="n">temp_residues_all</span><span class="p">:</span>
            <span class="n">res_names</span><span class="p">[</span><span class="n">temp_res</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">temp_res_name_count</span> <span class="o">=</span> <span class="n">res_names</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">temp_res_name_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">temp_res_name</span> <span class="o">=</span> <span class="n">ptp_eds_res_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_res_name</span> <span class="o">=</span> <span class="n">temp_res_name_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">temp_res_name</span></div>

<div class="viewcode-block" id="get_sys_title"><a class="viewcode-back" href="../../../SMArt.alchemy.html#SMArt.alchemy.top_matching_fnc.get_sys_title">[docs]</a><span class="k">def</span> <span class="nf">get_sys_title</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">sys_title_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PERTURBATION TOPOLOGY BASED ON N = </span><span class="si">{:}</span><span class="s1"> STATES</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">top</span> <span class="ow">in</span> <span class="n">sol</span><span class="o">.</span><span class="n">tops</span><span class="p">:</span>
        <span class="n">sys_title</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="s1">&#39;sys_title&#39;</span><span class="p">,</span> <span class="n">allow_not_found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys_title</span><span class="p">:</span>
            <span class="n">sys_title_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_title</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sys_title_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">DescriptionPart</span><span class="p">(</span><span class="n">lines</span> <span class="o">=</span> <span class="n">sys_title_lines</span><span class="p">)</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">toptp</span><span class="o">.</span><span class="n">add2container</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>   <span class="n">list_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Drazen Petrov.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>